(function(l,E,F){function m(a,f){b=this;n.push(this);this.container=l(a);this.container.wrapInner('<div class="balanced-gallery-wrapper"></div>');this.wrapper=l(this.container.children()[0]);this.elements=this.wrapper.children().map(function(){var a=l(this).find("img")[0];a===F&&(a=this);return{element:this,image:l(a)}});this.options=l.extend({},G,f);this.options.orientation=this.options.orientation.toLowerCase();this.options.autoResize&&(this.unadulteratedCSS={width:this.container[0].style.width},this.unadulteratedOptions=l.extend({},this.options),H());this.quickResize=!1;this.init();this.createGallery()}function H(){l(E).resize(function(){clearTimeout(u);u=setTimeout(function(){for(var a=0;a<n.length;a++)n[a].options.autoResize&&(b=n[a],n[a].recreate())},500)})}function y(){var a=b.options.padding,f=b.options.gridAspectRatio,e=parseInt(b.options.idealWidth-a,10),d=1/f*e,h=parseInt(b.options.viewportWidth%b.options.widthDivisor/2,10);0<h&&(b.wrapper.css({paddingLeft:h+a+"px"}),b.wrapper.width(b.options.viewportWidth-h));b.elements.each(function(){var c=this.image,g=p(c);g>=f?(c.height(d),c.width(d*g),g=(e-d*g)/2,c.css({left:g+"px",position:"absolute",maxWidth:"none"})):g<f&&(c.width(e),c.height(1/g*e),g=(d-1/g*e)/2,c.css({top:g+"px",position:"absolute",maxWidth:"none"}));b.quickResize?(c=c.parent(),c.width(e),c.height(d)):(c.wrap("<div></div>"),l(c[0].parentNode).css({position:"relative","float":"left",overflow:"hidden",width:e+"px",height:d+"px",margin:0,marginRight:a+"px",marginBottom:a+"px"}))});b.wrapper.append('<div style="clear: both;"></div>')}function I(){var a=0;b.elements.each(function(){a+=p(this.image)*b.options.idealHeight+b.options.padding});return a}function J(){return b.elements.map(function(){var a=p(this.image);return{element:this.element,image:this.image,weight:a}})}function K(){return b.elements.map(function(){var a=1/p(this.image);return{element:this.element,image:this.image,weight:a}})}function z(a,f){if(b.options.maintainOrder){var e=f;var d=a.length;if(0>=e)d=[];else{var h=L(a,e);--d;e-=2;for(var c=[],g;0<=e;){g=[];for(var k=h[d-1][e]+1;k<d+1;k++)g.push(a[k]);c=[g].concat(c);d=h[d-1][e];--e}e=[];for(h=0;h<d+1;h++)e.push(a[h]);d=[e].concat(c)}return d}d=M(a,f);if(b.options.shuffleUnorderedPartitions){for(c=0;c<d.length;c++)d[c]=A(d[c]);d=A(d)}c=d;for(e=0;e<c.length;e++)for(h=c[e],g=0;g<h.length;g++)b.wrapper.append(h[g].element);return d}function L(a,b){for(var e=a.length,d=[],f=0;f<e;f++){for(var c=[],g=0;g<b;g++)c.push(0);d.push(c)}f=[];for(c=0;c<e-1;c++){g=[];for(var k=0;k<b-1;k++)g.push(0);f.push(g)}for(c=0;c<e;c++)d[c][0]=a[c].weight+(0!==c?d[c-1][0]:0);for(c=0;c<b;c++)d[0][c]=a[0].weight;c=function(a,b){return a[0]-b[0]};for(g=1;g<e;g++)for(k=1;k<b;k++){for(var l=[],q=0;q<g;q++)l.push([Math.max(d[q][k-1],d[g][0]-d[q][0]),q]);l=l.sort(c)[0];d[g][k]=l[0];f[g-1][k-1]=l[1]}return f}function M(a,b){for(var f=a.sort(function(a,b){return b.weight-a.weight}),d=Array(b),h=0;h<b;h++)d[h]=[];for(h=0;h<f.length;h++){for(var c=d[0],g=B(c),k=0;k<d.length;k++){var l=B(d[k]);l<g&&(c=d[k],g=l)}c.push(f[h])}return d}function B(a){var b=0;l.each(a,function(a,d){b+=d.weight});return b}function C(){for(var a=b.options.padding,f=0,e=0,d,h=0;h<b.elements.length;h++){h==e&&(d=a*b.resizingValue[f].length,d=(b.options.viewportWidth-d)/b.resizingValue[f].ratio,e+=b.resizingValue[f].length,f++,r=0);var c=b.elements[h].image,g=parseInt(d,10),k=d*p(c);k=w(k);c.width(k);c.height(g)}}function D(){var a=b.options.padding,f=-1,e=0;r=0;for(var d,h,c=0;c<b.elements.length;c++){c==e&&(f++,b.resizingValue[f].columnHeight=0,d=b.options.viewportWidth/b.summedColRatios*b.resizingValue[f].ratio,d-=a,h=w(d),e+=b.resizingValue[f].length);var g=b.elements[c].image,k=parseInt(d*(1/p(g)),10);b.resizingValue[f].columnHeight+=k+a;g.width(h);g.height(k)}}function w(a){var b=parseInt(a,10);r+=a-b;.99999<=r&&(b+=1,--r);return b}function x(a){b.options.viewportWidth+b.options.padding!==b.container.width()&&(b.options.viewportWidth=b.container.width()-b.options.padding,b.wrapper.width(b.options.viewportWidth),"horizontal"==a?C():"vertical"==a?D():"grid"==a&&(b.options.idealWidth=b.options.viewportWidth/b.options.widthDivisor,y()))}function p(a){return a[0].naturalWidth/a[0].naturalHeight}function A(a){for(var b=a.length,e,d;b--;)d=Math.random()*b|0,e=a[b],a[b]=a[d],a[d]=e;return a}var n=[],b,G={autoResize:!0,background:null,idealHeight:null,idealWidth:null,maintainOrder:!0,orientation:"horizontal",padding:5,shuffleUnorderedPartitions:!0,gridAspectRatio:1,widthDivisor:4},u=null,r=0;l.fn.BalancedGallery=function(a){return this.each(function(){l.data(this,"plugin_BalancedGallery")||l.data(this,"plugin_BalancedGallery",new m(this,a))})};m.prototype.recreate=function(){this.options=l.extend({},this.unadulteratedOptions);this.container.css(this.unadulteratedCSS);this.quickResize=!0;this.init();this.createGallery()};m.prototype.init=function(){if(!1===this.quickResize){var a="inline-block";"vertical"==this.options.orientation&&(a="block");this.elements.each(function(){l(this.element).css({display:a,padding:0,margin:0});this.image.css({display:a,padding:0,margin:0})});var b=this.options.padding+"px";this.wrapper.css({fontSize:0,paddingTop:b,paddingLeft:b});null!==this.options.background&&this.wrapper.css({background:this.options.background})}this.options.viewportWidth=this.container.width()-this.options.padding;null===this.options.idealWidth&&(this.options.idealWidth=this.options.viewportWidth/this.options.widthDivisor);null===this.options.idealHeight&&(this.options.idealHeight=this.options.viewportWidth/this.options.widthDivisor);this.wrapper.width(this.options.viewportWidth)};m.prototype.createGallery=function(){var a=this.options.orientation;if("horizontal"===a){if(b.quickResize)C();else{a=Math.round(I()/b.options.viewportWidth);0<a&&1>a&&(a=1);var f=J();a=z(f,a);f=b.options.padding;var e=0;b.resizingValue=[];for(var d=0;d<a.length;d++){for(var h=0,c=0;c<a[d].length;c++)h+=a[d][c].weight;b.resizingValue[d]={ratio:h,length:a[d].length};r=0;h=(b.options.viewportWidth-f*a[d].length)/h;for(c=0;c<a[d].length;c++){var g=a[d][c].image;b.elements[e++]={element:a[d][c].element,image:g};var k=parseInt(h,10),t=h*p(g);t=w(t);g.width(t);g.height(k);g.css({margin:0,marginRight:f+"px",marginBottom:f+"px"})}}}x(b.options.orientation)}else if("vertical"===a){if(b.quickResize)D();else{a=Math.round(b.options.viewportWidth/b.options.idealWidth);f=b.elements.length;a=a<=f?a:f;f=K();a=z(f,a);for(f=0;f<a.length;f++)for(e="balanced-gallery-col"+f,b.wrapper.append('<div class="balanced-gallery-column" id="'+e+'" style="display: inline-block; padding: 0; margin: 0;"></div>'),e=l(b.wrapper.find("div#"+e)),d=0;d<a[f].length;d++)e.append(a[f][d].element);f=b.options.padding;e=[];h=d=0;b.resizingValue=[];for(c=r=0;c<a.length;c++){for(g=e[c]=0;g<a[c].length;g++)e[c]+=a[c][g].weight;e[c]+=f/(b.options.idealWidth-f)*a[c].length;d+=e[c]}b.summedColRatios=d;c=d/a.length;for(g=0;g<a.length;g++){k=c+(c-e[g]);t=b.options.viewportWidth/d*k-f;for(var q=w(t),n=0,m=0;m<a[g].length;m++){var v=a[g][m].image;b.elements[h++]={element:a[g][m].element,image:v};var u=Math.round(t*(1/p(v)));n+=u+f;v.width(q);v.height(u);v.css({margin:0,marginRight:f+"px",marginBottom:f+"px"})}b.resizingValue[g]={ratio:k,length:a[g].length,columnHeight:n}}}x(b.options.orientation);for(e=f=a=0;e<b.resizingValue.length;e++)a+=b.resizingValue[e].columnHeight;a=Math.round(a/b.resizingValue.length);for(e=0;e<b.resizingValue.length;e++)for(f+=b.resizingValue[e].length,d=Math.sign(a-b.resizingValue[e].columnHeight),h=f-1;a!=b.resizingValue[e].columnHeight;)b.elements[h].image.height(b.elements[h].image.height()+d),b.resizingValue[e].columnHeight+=d,h--,h<f-b.resizingValue[e].length&&(h=f-1)}else if("grid"===a)y(),x(a);else throw"BalancedGallery: Invalid Orientation.";}})(jQuery,window);