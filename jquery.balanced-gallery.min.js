(function(h,E,F){function m(a,g){b=this;n.push(this);this.container=a;h(this.container).wrapInner('<div class="balanced-gallery-wrapper"></div>');this.wrapper=h(this.container).children()[0];this.elements=h(this.wrapper).children().map(function(){var a=h(this).find("img")[0];a===F&&(a=this);return{element:this,image:h(a)}});this.options=h.extend({},G,g);this.options.orientation=this.options.orientation.toLowerCase();this.options.autoResize&&(this.unadulteratedCSS={width:h(this.container)[0].style.width},this.unadulteratedOptions=h.extend({},this.options),H());this.quickResize=!1;this.init();this.createGallery()}function H(){h(E).resize(function(){clearTimeout(u);u=setTimeout(function(){for(var a=0;a<n.length;a++)n[a].options.autoResize&&(b=n[a],n[a].recreate())},500)})}function y(){var a=b.options.padding,g=b.options.gridAspectRatio,e=parseInt(b.options.idealWidth-a,10),d=1/g*e,f=parseInt(b.options.viewportWidth%b.options.widthDivisor/2,10);if(0<f){var c=f+a,k=h(b.wrapper);k.css({paddingLeft:c+"px"});k.width(b.options.viewportWidth-f)}b.elements.each(function(){var c=this.image,f=q(c);f>=g?(c.height(d),c.width(d*f),f=(e-d*f)/2,c.css({left:f+"px",position:"absolute"})):f<g&&(c.width(e),c.height(1/f*e),f=(d-1/f*e)/2,c.css({top:f+"px",position:"absolute"}));b.quickResize?(c=c.parent(),c.width(e),c.height(d)):(c.wrap("<div></div>"),h(c[0].parentNode).css({position:"relative",display:"inline-block",overflow:"hidden",width:e+"px",height:d+"px",margin:0,marginRight:a+"px",marginBottom:a+"px"}))})}function I(){var a=0;b.elements.each(function(){a+=q(this.image)*b.options.idealHeight+b.options.padding});return a}function J(){return b.elements.map(function(){var a=q(this.image);return{element:this.element,image:this.image,weight:a}})}function K(){return b.elements.map(function(){var a=1/q(this.image);return{element:this.element,image:this.image,weight:a}})}function z(a,g){if(b.options.maintainOrder){var e;var d=g;e=a.length;if(0>=d)e=[];else{var f=L(a,d);--e;for(var d=d-2,c=[],k;0<=d;){k=[];for(var l=f[e-1][d]+1;l<e+1;l++)k.push(a[l]);c=[k].concat(c);e=f[e-1][d];--d}d=[];for(f=0;f<e+1;f++)d.push(a[f]);e=[d].concat(c)}return e}e=M(a,g);if(b.options.shuffleUnorderedPartitions){for(c=0;c<e.length;c++)e[c]=A(e[c]);e=A(e)}c=e;for(d=0;d<c.length;d++)for(f=c[d],k=0;k<f.length;k++)h(b.wrapper).append(f[k].element);return e}function L(a,b){for(var e=a.length,d=[],f=0;f<e;f++){for(var c=[],g=0;g<b;g++)c.push(0);d.push(c)}f=[];for(c=0;c<e-1;c++){for(var g=[],l=0;l<b-1;l++)g.push(0);f.push(g)}for(c=0;c<e;c++)d[c][0]=a[c].weight+(0!==c?d[c-1][0]:0);for(c=0;c<b;c++)d[0][c]=a[0].weight;c=function(a,b){return a[0]-b[0]};for(g=1;g<e;g++)for(l=1;l<b;l++){for(var h=[],r=0;r<g;r++)h.push([Math.max(d[r][l-1],d[g][0]-d[r][0]),r]);h=h.sort(c)[0];d[g][l]=h[0];f[g-1][l-1]=h[1]}return f}function M(a,b){for(var g=a.sort(function(a,b){return b.weight-a.weight}),d=Array(b),f=0;f<b;f++)d[f]=[];for(f=0;f<g.length;f++){for(var c=d[0],k=B(c),h=0;h<d.length;h++){var p=B(d[h]);p<k&&(c=d[h],k=p)}c.push(g[f])}return d}function B(a){var b=0;h.each(a,function(a,d){b+=d.weight});return b}function C(){for(var a=b.options.padding,g=0,e=0,d,f=0;f<b.elements.length;f++){f==e&&(d=a*b.resizingValue[g].length,d=(b.options.viewportWidth-d)/b.resizingValue[g].ratio,e+=b.resizingValue[g].length,g++,t=0);var c=b.elements[f].image,h=parseInt(d,10),l=d*q(c),l=w(l);c.width(l);c.height(h)}}function D(){var a=b.options.padding,g=-1,e=0;t=0;for(var d,f,c=0;c<b.elements.length;c++){c==e&&(g++,b.resizingValue[g].columnHeight=0,d=b.options.viewportWidth/b.summedColRatios*b.resizingValue[g].ratio,d-=a,f=w(d),e+=b.resizingValue[g].length);var h=b.elements[c].image,l=parseInt(d*(1/q(h)),10);b.resizingValue[g].columnHeight+=l+a;h.width(f);h.height(l)}}function w(a){var b=parseInt(a,10);t+=a-b;.99999<=t&&(b+=1,--t);return b}function x(a){b.options.viewportWidth+b.options.padding!==h(b.container).width()&&(b.options.viewportWidth=h(b.container).width()-b.options.padding,h(b.wrapper).width(b.options.viewportWidth),"horizontal"==a?C():"vertical"==a?D():"grid"==a&&(b.options.idealWidth=b.options.viewportWidth/b.options.widthDivisor,y()))}function q(a){return a[0].naturalWidth/a[0].naturalHeight}function A(a){for(var b=a.length,e,d;b--;)d=Math.random()*b|0,e=a[b],a[b]=a[d],a[d]=e;return a}var n=[],b,G={autoResize:!0,background:null,idealHeight:null,idealWidth:null,maintainOrder:!0,orientation:"horizontal",padding:5,shuffleUnorderedPartitions:!0,gridAspectRatio:1,widthDivisor:4},u=null,t=0;h.fn.BalancedGallery=function(a){return this.each(function(){h.data(this,"plugin_BalancedGallery")||h.data(this,"plugin_BalancedGallery",new m(this,a))})};m.prototype.recreate=function(){this.options=h.extend({},this.unadulteratedOptions);h(this.container).css(this.unadulteratedCSS);this.quickResize=!0;this.init();this.createGallery()};m.prototype.init=function(){if(!1===this.quickResize){var a="inline-block";"vertical"==this.options.orientation&&(a="block");this.elements.each(function(){h(this.element).css({display:a,padding:0,margin:0});this.image.css({display:a,padding:0,margin:0})});var b=this.options.padding+"px";h(this.wrapper).css({fontSize:0,paddingTop:b,paddingLeft:b});null!==this.options.background&&h(this.wrapper).css({background:this.options.background})}this.options.viewportWidth=h(this.container).width()-this.options.padding;null===this.options.idealWidth&&(this.options.idealWidth=this.options.viewportWidth/this.options.widthDivisor);null===this.options.idealHeight&&(this.options.idealHeight=this.options.viewportWidth/this.options.widthDivisor);h(this.wrapper).width(this.options.viewportWidth)};m.prototype.createGallery=function(){var a=this.options.orientation;if("horizontal"===a){var g;if(b.quickResize)C();else{a=Math.round(I()/b.options.viewportWidth);0<a&&1>a&&(a=1);g=J();a=z(g,a);g=b.options.padding;var e=0;b.resizingValue=[];for(var d=0;d<a.length;d++){for(var f=0,c=0;c<a[d].length;c++)f+=a[d][c].weight;b.resizingValue[d]={ratio:f,length:a[d].length};t=0;f=(b.options.viewportWidth-g*a[d].length)/f;for(c=0;c<a[d].length;c++){var k=a[d][c].image;b.elements[e++]={element:a[d][c].element,image:k};var l=parseInt(f,10),p=f*q(k),p=w(p);k.width(p);k.height(l);k.css({margin:0,marginRight:g+"px",marginBottom:g+"px"})}}}x(b.options.orientation)}else if("vertical"===a){if(b.quickResize)D();else{a=Math.round(b.options.viewportWidth/b.options.idealWidth);g=b.elements.length;a=a<=g?a:g;g=K();a=z(g,a);g=h(b.wrapper);for(e=0;e<a.length;e++)for(d="balanced-gallery-col"+e,g.append('<div class="balanced-gallery-column" id="'+d+'" style="display: inline-block; padding: 0; margin: 0;"></div>'),d=h(g.find("div#"+d)),f=0;f<a[e].length;f++)d.append(a[e][f].element);g=b.options.padding;e=[];f=d=0;b.resizingValue=[];for(c=t=0;c<a.length;c++){for(k=e[c]=0;k<a[c].length;k++)e[c]+=a[c][k].weight;e[c]+=g/(b.options.idealWidth-g)*a[c].length;d+=e[c]}b.summedColRatios=d;c=d/a.length;for(k=0;k<a.length;k++){for(var l=c+(c-e[k]),p=b.options.viewportWidth/d*l-g,r=w(p),n=0,m=0;m<a[k].length;m++){var v=a[k][m].image;b.elements[f++]={element:a[k][m].element,image:v};var u=Math.round(p*(1/q(v))),n=n+(u+g);v.width(r);v.height(u);v.css({margin:0,marginRight:g+"px",marginBottom:g+"px"})}b.resizingValue[k]={ratio:l,length:a[k].length,columnHeight:n}}}x(b.options.orientation);for(e=g=a=0;e<b.resizingValue.length;e++)a+=b.resizingValue[e].columnHeight;a=Math.round(a/b.resizingValue.length);for(e=0;e<b.resizingValue.length;e++)for(g+=b.resizingValue[e].length,d=Math.sign(a-b.resizingValue[e].columnHeight),f=g-1;a!=b.resizingValue[e].columnHeight;)b.elements[f].image.height(b.elements[f].image.height()+d),b.resizingValue[e].columnHeight+=d,f--,f<g-b.resizingValue[e].length&&(f=g-1)}else if("grid"===a)y(),x(a);else throw"BalancedGallery: Invalid Orientation.";}})(jQuery,window);