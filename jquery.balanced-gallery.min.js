(function(g,E,M){function p(a,f){b=this;n.push(this);this.element=a;g(this.element).wrapInner('<div class="balanced-gallery-container"></div>');this.container=g(this.element).children()[0];this.elementChildren=g(this.container).children("img");this.options=g.extend({},F,f);this.options.orientation=this.options.orientation.toLowerCase();this.options.autoResize&&(this.unadulteratedCSS={width:g(this.element)[0].style.width},this.unadulteratedOptions=g.extend({},this.options),G());this.quickResize=!1;this.init();this.createGallery()}function G(){g(E).resize(function(){clearTimeout(u);u=setTimeout(function(){for(var a=0;a<n.length;a++)n[a].options.autoResize&&(b=n[a],n[a].recreate())},500)})}function y(){var a=b.options.padding,f=b.options.gridAspectRatio,e=parseInt(b.options.idealWidth-a,10),d=1/f*e,k='<div style="position: relative; display: inline-block; overflow: hidden; width: '+e+"px; height: "+d+"px; margin: 0 "+a+"px "+a+'px 0;"></div>',c=parseInt(b.options.viewportWidth%b.options.widthDivisor/2,10);if(0<c){var a=c+a,h=g(b.container);h.css({paddingLeft:a+"px"});h.width(b.options.viewportWidth-c)}b.elementChildren.each(function(){var a=g(this),c=q(a);c>=f?(a.height(d),a.width(d*c),c=(e-d*c)/2,a.css({left:c+"px",position:"absolute"})):c<f&&(a.width(e),a.height(1/c*e),c=(d-1/c*e)/2,a.css({top:c+"px",position:"absolute"}));b.quickResize?(a=a.parent(),a.width(e),a.height(d)):a.wrap(k)})}function H(){var a=0;b.elementChildren.each(function(){a+=q(g(this))*b.options.idealHeight+b.options.padding});return a}function I(){return b.elementChildren.map(function(){return{element:this,weight:q(g(this))}})}function J(){return b.elementChildren.map(function(){return{element:this,weight:1/q(g(this))}})}function z(a,f){if(b.options.maintainOrder){var e;var d=f;e=a.length;if(0>=d)e=[];else{var k=K(a,d);--e;for(var d=d-2,c=[],h;0<=d;){h=[];for(var l=k[e-1][d]+1;l<e+1;l++)h.push(a[l]);c=[h].concat(c);e=k[e-1][d];--d}d=[];for(k=0;k<e+1;k++)d.push(a[k]);e=[d].concat(c)}return e}e=L(a,f);if(b.options.shuffleUnorderedPartitions){for(c=0;c<e.length;c++)e[c]=A(e[c]);e=A(e)}c=e;g(b.container).html("");for(d=0;d<c.length;d++)for(k=c[d],h=0;h<k.length;h++)g(b.container).append(k[h].element);return e}function K(a,b){for(var e=a.length,d=[],f=0;f<e;f++){for(var c=[],h=0;h<b;h++)c.push(0);d.push(c)}f=[];for(c=0;c<e-1;c++){for(var h=[],g=0;g<b-1;g++)h.push(0);f.push(h)}for(c=0;c<e;c++)d[c][0]=a[c].weight+(0!==c?d[c-1][0]:0);for(c=0;c<b;c++)d[0][c]=a[0].weight;c=function(a,b){return a[0]-b[0]};for(h=1;h<e;h++)for(g=1;g<b;g++){for(var m=[],r=0;r<h;r++)m.push([Math.max(d[r][g-1],d[h][0]-d[r][0]),r]);m=m.sort(c)[0];d[h][g]=m[0];f[h-1][g-1]=m[1]}return f}function L(a,b){for(var e=a.sort(function(a,b){return b.weight-a.weight}),d=Array(b),f=0;f<b;f++)d[f]=[];for(f=0;f<e.length;f++){for(var c=d[0],h=B(c),g=0;g<d.length;g++){var m=B(d[g]);m<h&&(c=d[g],h=m)}c.push(e[f])}return d}function B(a){var b=0;g.each(a,function(a,d){b+=d.weight});return b}function C(){for(var a=b.options.padding,f=0,e=0,d,g=0;g<b.elementChildren.length;g++){g==e&&(d=a*b.resizingValue[f].length,d=(b.options.viewportWidth-d)/b.resizingValue[f].ratio,e+=b.resizingValue[f].length,f++,t=0);var c=b.elementChildren[g],h=parseInt(d,10),l=d*q(c),l=w(l);c.width(l);c.height(h)}}function D(){var a=b.options.padding,f=-1,e=0;t=0;for(var d,g,c=0;c<b.elementChildren.length;c++){c==e&&(f++,b.resizingValue[f].columnHeight=0,d=b.options.viewportWidth/b.summedColRatios*b.resizingValue[f].ratio,d-=a,g=w(d),e+=b.resizingValue[f].length);var h=b.elementChildren[c],l=parseInt(d*(1/q(h)),10);b.resizingValue[f].columnHeight+=l+a;h.width(g);h.height(l)}}function w(a){var b=parseInt(a,10);t+=a-b;.99999<=t&&(b+=1,--t);return b}function x(a){b.options.viewportWidth+b.options.padding!==g(b.element).width()&&(b.options.viewportWidth=g(b.element).width()-b.options.padding,g(b.container).width(b.options.viewportWidth),"horizontal"==a?C():"vertical"==a?D():"grid"==a&&(b.options.idealWidth=b.options.viewportWidth/b.options.widthDivisor,y()))}function q(a){return a[0].naturalWidth/a[0].naturalHeight}function A(a){for(var b=a.length,e,d;b--;)d=Math.random()*b|0,e=a[b],a[b]=a[d],a[d]=e;return a}var n=[],b,F={autoResize:!0,background:null,idealHeight:null,idealWidth:null,maintainOrder:!0,orientation:"horizontal",padding:5,shuffleUnorderedPartitions:!0,gridAspectRatio:1,widthDivisor:4},u=null,t=0;g.fn.BalancedGallery=function(a){return this.each(function(){g.data(this,"plugin_BalancedGallery")||g.data(this,"plugin_BalancedGallery",new p(this,a))})};p.prototype.recreate=function(){this.options=g.extend({},this.unadulteratedOptions);g(this.element).css(this.unadulteratedCSS);this.quickResize=!0;this.init();this.createGallery()};p.prototype.init=function(){if(!1===this.quickResize){this.elementChildren.each(function(){g(this).css({display:"inline-block",padding:0,margin:0})});var a=this.options.padding+"px";g(this.container).css({fontSize:0,paddingTop:a,paddingLeft:a});null!==this.options.background&&g(this.container).css({background:this.options.background})}this.options.viewportWidth=g(this.element).width()-this.options.padding;null===this.options.idealWidth&&(this.options.idealWidth=this.options.viewportWidth/this.options.widthDivisor);null===this.options.idealHeight&&(this.options.idealHeight=this.options.viewportWidth/this.options.widthDivisor);g(this.container).width(this.options.viewportWidth)};p.prototype.createGallery=function(){var a=this.options.orientation;if("horizontal"===a){var f;if(b.quickResize)C();else{a=Math.round(H()/b.options.viewportWidth);0<a&&1>a&&(a=1);f=I();a=z(f,a);f=b.options.padding;var e=0;b.resizingValue=[];for(var d=0;d<a.length;d++){for(var k=0,c=0;c<a[d].length;c++)k+=a[d][c].weight;b.resizingValue[d]={ratio:k,length:a[d].length};t=0;k=(b.options.viewportWidth-f*a[d].length)/k;for(c=0;c<a[d].length;c++){var h=g(a[d][c].element);b.elementChildren[e++]=h;var l=parseInt(k,10),m=k*q(h),m=w(m);h.width(m);h.height(l);h.css({margin:0,marginRight:f+"px",marginBottom:f+"px"})}}}x(b.options.orientation)}else if("vertical"===a){if(b.quickResize)D();else{a=Math.round(b.options.viewportWidth/b.options.idealWidth);f=b.elementChildren.length;a=a<=f?a:f;f=J();a=z(f,a);f=g(b.container);f.html("");for(e=0;e<a.length;e++)for(d="balanced-gallery-col"+e,f.append('<div class="balanced-gallery-column" id="'+d+'" style="float: left; padding: 0; margin: 0;"></div>'),d=g(f.find("div#"+d)),k=0;k<a[e].length;k++)d.append(a[e][k].element).append('<br style="display: block;"/>');f.append('<div class="balanced-gallery-clearing" style="clear: both;"></div>');f=b.options.padding;e=[];k=d=0;b.resizingValue=[];for(c=t=0;c<a.length;c++){for(h=e[c]=0;h<a[c].length;h++)e[c]+=a[c][h].weight;e[c]+=f/(b.options.idealWidth-f)*a[c].length;d+=e[c]}b.summedColRatios=d;c=d/a.length;for(h=0;h<a.length;h++){for(var l=c+(c-e[h]),m=b.options.viewportWidth/d*l-f,r=w(m),n=0,p=0;p<a[h].length;p++){var v=g(a[h][p].element);b.elementChildren[k++]=v;var u=Math.round(m*(1/q(v))),n=n+(u+f);v.width(r);v.height(u);v.css({margin:0,marginRight:f+"px",marginBottom:f+"px"})}b.resizingValue[h]={ratio:l,length:a[h].length,columnHeight:n}}}x(b.options.orientation);for(e=f=a=0;e<b.resizingValue.length;e++)a+=b.resizingValue[e].columnHeight;a=Math.round(a/b.resizingValue.length);for(e=0;e<b.resizingValue.length;e++)for(f+=b.resizingValue[e].length,d=Math.sign(a-b.resizingValue[e].columnHeight),k=f-1;a!=b.resizingValue[e].columnHeight;)b.elementChildren[k].height(b.elementChildren[k].height()+d),b.resizingValue[e].columnHeight+=d,k--,k<f-b.resizingValue[e].length&&(k=f-1)}else if("grid"===a)y(),x(a);else throw"BalancedGallery: Invalid Orientation.";}})(jQuery,window);