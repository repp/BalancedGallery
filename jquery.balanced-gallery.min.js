(function(g,E,M){function p(a,d){b=this;n.push(this);this.element=a;g(this.element).wrapInner('<div class="balanced-gallery-container"></div>');this.container=g(this.element).children()[0];this.elementChildren=g(this.container).children("img");this.options=g.extend({},F,d);this.options.orientation=this.options.orientation.toLowerCase();this.options.autoResize&&(this.unadulteratedCSS={width:g(this.element)[0].style.width},this.unadulteratedOptions=g.extend({},this.options),G());this.quickResize=!1;this.init();this.createGallery()}function G(){g(E).resize(function(){clearTimeout(u);u=setTimeout(function(){for(var a=0;a<n.length;a++)n[a].options.autoResize&&(b=n[a],n[a].recreate())},500)})}function y(){var a=b.options.padding,d=parseInt(b.options.idealWidth,10)-a,f='<div style="position: relative; display: inline-block; overflow: hidden; width: '+d+"px; height: "+d+"px; margin: 0 "+a+"px "+a+'px 0;"></div>',c=parseInt(b.options.viewportWidth%b.options.widthDivisor/2,10);if(0<c){var a=c+a,h=g(b.container);h.css({paddingLeft:a+"px"});h.width(b.options.viewportWidth-c)}b.elementChildren.each(function(){var a=g(this),c=q(a);1<=c?(a.height(d),a.width(d*c),c=(d*c-d)/2*-1,a.css({left:c+"px",position:"absolute"})):1>c&&(a.width(d),a.height(1/c*d),c=(1/c*d-d)/2*-1,a.css({top:c+"px",position:"absolute"}));b.quickResize?(a=a.parent(),a.width(d),a.height(d)):a.wrap(f)})}function H(){var a=0;b.elementChildren.each(function(){a+=q(g(this))*b.options.idealHeight+b.options.padding});return a}function I(){return b.elementChildren.map(function(){return{element:this,weight:q(g(this))}})}function J(){return b.elementChildren.map(function(){return{element:this,weight:1/q(g(this))}})}function z(a,d){if(b.options.maintainOrder){var f;var c=d;f=a.length;if(0>=c)f=[];else{var h=K(a,c);--f;for(var c=c-2,e=[],k;0<=c;){k=[];for(var m=h[f-1][c]+1;m<f+1;m++)k.push(a[m]);e=[k].concat(e);f=h[f-1][c];--c}c=[];for(h=0;h<f+1;h++)c.push(a[h]);f=[c].concat(e)}return f}f=L(a,d);if(b.options.shuffleUnorderedPartitions){for(e=0;e<f.length;e++)f[e]=A(f[e]);f=A(f)}e=f;g(b.container).html("");for(c=0;c<e.length;c++)for(h=e[c],k=0;k<h.length;k++)g(b.container).append(h[k].element);return f}function K(a,b){for(var d=a.length,c=[],h=0;h<d;h++){for(var e=[],k=0;k<b;k++)e.push(0);c.push(e)}h=[];for(e=0;e<d-1;e++){for(var k=[],g=0;g<b-1;g++)k.push(0);h.push(k)}for(e=0;e<d;e++)c[e][0]=a[e].weight+(0!==e?c[e-1][0]:0);for(e=0;e<b;e++)c[0][e]=a[0].weight;e=function(a,c){return a[0]-c[0]};for(k=1;k<d;k++)for(g=1;g<b;g++){for(var l=[],r=0;r<k;r++)l.push([Math.max(c[r][g-1],c[k][0]-c[r][0]),r]);l=l.sort(e)[0];c[k][g]=l[0];h[k-1][g-1]=l[1]}return h}function L(a,b){for(var d=a.sort(function(a,b){return b.weight-a.weight}),c=Array(b),h=0;h<b;h++)c[h]=[];for(h=0;h<d.length;h++){for(var e=c[0],k=B(e),g=0;g<c.length;g++){var l=B(c[g]);l<k&&(e=c[g],k=l)}e.push(d[h])}return c}function B(a){var b=0;g.each(a,function(a,c){b+=c.weight});return b}function C(){for(var a=b.options.padding,d=0,f=0,c,h=0;h<b.elementChildren.length;h++){h==f&&(c=a*b.resizingValue[d].length,c=(b.options.viewportWidth-c)/b.resizingValue[d].ratio,f+=b.resizingValue[d].length,d++,t=0);var e=b.elementChildren[h],k=parseInt(c,10),g=c*q(e),g=w(g);e.width(g);e.height(k)}}function D(){var a=b.options.padding,d=-1,f=0;t=0;for(var c,h,e=0;e<b.elementChildren.length;e++){e==f&&(d++,b.resizingValue[d].columnHeight=0,c=b.options.viewportWidth/b.summedColRatios*b.resizingValue[d].ratio,c-=a,h=w(c),f+=b.resizingValue[d].length);var g=b.elementChildren[e],m=parseInt(c*(1/q(g)),10);b.resizingValue[d].columnHeight+=m+a;g.width(h);g.height(m)}}function w(a){var b=parseInt(a,10);t+=a-b;.99999<=t&&(b+=1,--t);return b}function x(a){b.options.viewportWidth+b.options.padding!==g(b.element).width()&&(b.options.viewportWidth=g(b.element).width()-b.options.padding,g(b.container).width(b.options.viewportWidth),"horizontal"==a?C():"vertical"==a?D():"grid"==a&&(b.options.idealWidth=b.options.viewportWidth/b.options.widthDivisor,y()))}function q(a){return a[0].naturalWidth/a[0].naturalHeight}function A(a){for(var b=a.length,f,c;b--;)c=Math.random()*b|0,f=a[b],a[b]=a[c],a[c]=f;return a}var n=[],b,F={autoResize:!0,background:null,idealHeight:null,idealWidth:null,maintainOrder:!0,orientation:"horizontal",padding:5,shuffleUnorderedPartitions:!0,widthDivisor:4},u=null,t=0;g.fn.BalancedGallery=function(a){return this.each(function(){g.data(this,"plugin_BalancedGallery")||g.data(this,"plugin_BalancedGallery",new p(this,a))})};p.prototype.recreate=function(){this.options=g.extend({},this.unadulteratedOptions);g(this.element).css(this.unadulteratedCSS);this.quickResize=!0;this.init();this.createGallery()};p.prototype.init=function(){if(!1===this.quickResize){this.elementChildren.each(function(){g(this).css({display:"inline-block",padding:0,margin:0})});var a=this.options.padding+"px";g(this.container).css({fontSize:0,paddingTop:a,paddingLeft:a});null!==this.options.background&&g(this.container).css({background:this.options.background})}this.options.viewportWidth=g(this.element).width()-this.options.padding;null===this.options.idealWidth&&(this.options.idealWidth=this.options.viewportWidth/this.options.widthDivisor);null===this.options.idealHeight&&(this.options.idealHeight=this.options.viewportWidth/this.options.widthDivisor);g(this.container).width(this.options.viewportWidth)};p.prototype.createGallery=function(){var a=this.options.orientation;if("horizontal"===a){var d;if(b.quickResize)C();else{a=Math.round(H()/b.options.viewportWidth);0<a&&1>a&&(a=1);d=I();a=z(d,a);d=b.options.padding;var f=0;b.resizingValue=[];for(var c=0;c<a.length;c++){for(var h=0,e=0;e<a[c].length;e++)h+=a[c][e].weight;b.resizingValue[c]={ratio:h,length:a[c].length};t=0;h=(b.options.viewportWidth-d*a[c].length)/h;for(e=0;e<a[c].length;e++){var k=g(a[c][e].element);b.elementChildren[f++]=k;var m=parseInt(h,10),l=h*q(k),l=w(l);k.width(l);k.height(m);k.css({margin:0,marginRight:d+"px",marginBottom:d+"px"})}}}x(b.options.orientation)}else if("vertical"===a){if(b.quickResize)D();else{a=Math.round(b.options.viewportWidth/b.options.idealWidth);d=b.elementChildren.length;a=a<=d?a:d;d=J();a=z(d,a);d=g(b.container);d.html("");for(f=0;f<a.length;f++)for(c="balanced-gallery-col"+f,d.append('<div class="balanced-gallery-column" id="'+c+'" style="float: left; padding: 0; margin: 0;"></div>'),c=g(d.find("div#"+c)),h=0;h<a[f].length;h++)c.append(a[f][h].element).append('<br style="display: block;"/>');d.append('<div class="balanced-gallery-clearing" style="clear: both;"></div>');d=b.options.padding;f=[];h=c=0;b.resizingValue=[];for(e=t=0;e<a.length;e++){for(k=f[e]=0;k<a[e].length;k++)f[e]+=a[e][k].weight;f[e]+=d/(b.options.idealWidth-d)*a[e].length;c+=f[e]}b.summedColRatios=c;e=c/a.length;for(k=0;k<a.length;k++){for(var m=e+(e-f[k]),l=b.options.viewportWidth/c*m-d,r=w(l),n=0,p=0;p<a[k].length;p++){var v=g(a[k][p].element);b.elementChildren[h++]=v;var u=Math.round(l*(1/q(v))),n=n+(u+d);v.width(r);v.height(u);v.css({margin:0,marginRight:d+"px",marginBottom:d+"px"})}b.resizingValue[k]={ratio:m,length:a[k].length,columnHeight:n}}}x(b.options.orientation);for(f=d=a=0;f<b.resizingValue.length;f++)a+=b.resizingValue[f].columnHeight;a=Math.round(a/b.resizingValue.length);for(f=0;f<b.resizingValue.length;f++)for(d+=b.resizingValue[f].length,c=Math.sign(a-b.resizingValue[f].columnHeight),h=d-1;a!=b.resizingValue[f].columnHeight;)b.elementChildren[h].height(b.elementChildren[h].height()+c),b.resizingValue[f].columnHeight+=c,h--,h<d-b.resizingValue[f].length&&(h=d-1)}else if("grid"===a)y(),x(a);else throw"BalancedGallery: Invalid Orientation.";}})(jQuery,window);